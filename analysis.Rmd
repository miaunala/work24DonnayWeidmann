---
title: "analysis"
author: "Nathalie Guibert"
output: html_document
date: "2024-07-10"
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library("lfe")
library("ggplot2")
library("countrycode")
library("dplyr")

setwd("C:/Users/whatt/Desktop/2024_ResAss_UZHIPZ_WeidmannDonnay/work24DonnayWeidmann")
joined_data <- read_csv("data/joined_data.csv")
```

# Analysis part

## Create important variables before analysis
### Create weight with post count
```{r}
joined_data$weight_p =joined_data$post_count
```

### Create time lags for potential later time series analysis
#### Governmental power, Regional autonomy, Separatism/irridentism
```{r}
joined_data <- joined_data %>%
  group_by(org_id) %>%
  mutate(`Governmental power lag` = lag(gov_pow, order_by = year)) %>%
  mutate(`Regional autonomy lag` = lag(reg_autonom, order_by = year)) %>%
  mutate(`Separatism/irredentism lag` = lag(sep_irred, order_by = year)) %>%
  ungroup()
```

### Create logs of post count for log_count_model
```{r}
joined_data$log_post_count <- log(joined_data$post_count + 1)  # Adding 1 to avoid log(0)
```

## Models

### Fixed effects model for countries and years with clustered standard errors
```{r}
model_fe <- felm(prop_global ~ `gov_pow` + `reg_autonom` + `sep_irred` | country_gwid + year|0|country_gwid + year, data = joined_data)
summary(model_fe)
```

### Same model with weighting
```{r}
model_fe_weighted <- felm(prop_global ~ gov_pow + reg_autonom + sep_irred | country_gwid + year|0|country_gwid + year, data = joined_data, weights= joined_data$weight_p)
summary(model_fe_weighted)
```

### Log-transformed model, thus, controlling for post counts [including log-transformed post count] (with weighting -> !dunno if this doubles the control and weight variable)
```{r}
log_count_model <- felm(prop_global ~ gov_pow + reg_autonom + sep_irred + log_post_count | country_gwid + year | 0 | country_gwid + year, data = joined_data,weights= joined_data$weight_p )
summary(log_count_model)
```

### Descriptive Analysis of global posts over years (general)
```{r}
global_year <- ggplot(data = joined_data, mapping = aes(x = year, y = global_posts)) +
  geom_bar(stat = "identity") +
  labs(title = "Number of Global Posts by Year",
       x = "Year",
       y = "Number of Global Posts") +
  theme_minimal()
global_year
```


## Regions
### Add regions and countries
```{r}
joined_data$country_name <- NA
joined_data$region <- NA

# Loop through each row and match the G&W code to the country name
for (i in 1:nrow(joined_data)) {
  gwid <- joined_data$country_gwid[i]
  joined_data$country_name[i] <- countrycode(gwid, "gwn", "country.name")
  joined_data$region[i] <- countrycode(gwid, "gwn", "region")
}
```

### Descriptive Analysis of global posts over years and regions
```{r}
joined_data$year <- as.factor(joined_data$year)

global_year_region <- ggplot(data = joined_data, mapping = aes(x = year, y = global_posts, fill = region)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  labs(title = "Number of Global Posts by Year and Region",
       x = "Year",
       y = "Number of Global Posts") +
  scale_x_discrete(drop = FALSE) +  
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))
global_year_region
``` 

### Fixed effects model for regions and years with clustered standard errors
```{r}
model_regions <- felm(prop_global ~ gov_pow + reg_autonom + sep_irred | region + year|0|region + year, data = joined_data)
summary(model_regions)


# Same but with weights 
model_regions_weighted <- felm(prop_global ~ gov_pow +reg_autonom + sep_irred | region + year|0|region + year, data = joined_data, weights= joined_data$weight_p)
summary(model_regions_weighted)
```


## Welche Organisationen verwenden mehr globale Posts? Hier würde ich einfach nach “governmental power”, “regional autonomy” und “separatism” unterscheiden.
### Calculate the average share of global posts for each organisation according to the variables
```{r}
summary_data <- joined_data %>%
  group_by(gov_pow, reg_autonom, sep_irred, orgname) %>%
  summarise(
    avg_prop_global = mean(prop_global, na.rm = TRUE),
    .groups = "drop"
  )
  
summary_data <- summary_data %>%
  filter(!is.na(gov_pow), !is.na(avg_prop_global))
```

### Boxplot für den Anteil globaler Posts nach "Governmental power"
```{r}
ggplot(summary_data, aes(x = gov_pow, y = avg_prop_global)) +
  geom_boxplot() +
  labs(title = "Average Proportion of Global Posts by Governmental Power",
       x = "Governmental Power",
       y = "Average Proportion of Global Posts") +
  theme_minimal()
```

### Boxplot für den Anteil globaler Posts nach "Regional autonomy"
```{r}
ggplot(summary_data, aes(x = reg_autonom, y = avg_prop_global)) +
  geom_boxplot() +
  labs(title = "Average Proportion of Global Posts by Regional Autonomy",
       x = "Regional Autonomy",
       y = "Average Proportion of Global Posts") +
  theme_minimal()
```

### Boxplot für den Anteil globaler Posts nach "Separatism/irredentism"
```{r}
ggplot(summary_data, aes(x = sep_irred, y = avg_prop_global)) +
  geom_boxplot() +
  labs(title = "Average Proportion of Global Posts by Separatism/Irredentism",
       x = "Separatism/Irredentism",
       y = "Average Proportion of Global Posts") +
  theme_minimal()
```


## Mean over time 

### Group by year and Governmental power
(I left the NA inside, as it is interesting how it develops concurrently)
```{r}
gov_power_yearly <- joined_data %>%
  group_by(year, gov_pow) %>%
  summarise(
    avg_prop_global = mean(prop_global, na.rm = TRUE),
    .groups = "drop"
  )
  
ggplot(gov_power_yearly, aes(x = year, y = avg_prop_global, color = as.factor(gov_pow), group = gov_pow)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Proportion of Global Posts by Governmental Power Over Time",
       x = "Year",
       y = "Average Proportion of Global Posts",
       color = "Governmental Power") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Group by year and Regional autonomy
```{r}
reg_autonomy_yearly <- joined_data %>%
  group_by(year, reg_autonom) %>%
  summarise(
    avg_prop_global = mean(prop_global, na.rm = TRUE),
    .groups = "drop"
  )
  
ggplot(reg_autonomy_yearly, aes(x = year, y = avg_prop_global, color = as.factor(reg_autonom), group = reg_autonom)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Proportion of Global Posts by Regional Autonomy Over Time",
       x = "Year",
       y = "Average Proportion of Global Posts",
       color = "Regional Autonomy") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Group by year and Separatism/irredentism
```{r}
sep_irredentism_yearly <- joined_data %>%
  group_by(year, sep_irred) %>%
  summarise(
    avg_prop_global = mean(prop_global, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(sep_irredentism_yearly, aes(x = year, y = avg_prop_global, color = as.factor(sep_irred), group = sep_irred)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Proportion of Global Posts by Separatism/Irredentism Over Time",
       x = "Year",
       y = "Average Proportion of Global Posts",
       color = "Separatism/Irredentism") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```






